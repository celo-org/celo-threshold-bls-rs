version: 2.1

jobs:
  test:
    docker:
      - image: cimg/rust:latest
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: |
            cargo install cargo-audit
            rustup component add clippy
      - run:
          name: Tests
          command: |
            cargo test --all
      - run:
          name: Check style
          command: |
            cargo fmt --all -- --check
            cargo clippy --all-targets --all-features -- -D warnings
      - run:
          name: Audit Dependencies
          command: cargo audit

  build-wasm:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build WASM
          command: make wasm
      - store_artifacts:
          path: output/wasm

  build-jvm:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build JVM
          command: make jvm
      - store_artifacts:
          path: output/jvm

  build-android:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build Android
          command: make android
      - store_artifacts:
          path: output/android

  build-ios:
    macos:
      xcode: 15.1.0
    steps:
      - checkout
      - run:
          name: Install Rust
          command: |
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.62.0
            source "$HOME/.cargo/env"
      - run:
          name: Build iOS
          command: make ios
      - store_artifacts:
          path: output/ios

workflows:
  version: 2
  build_and_test:
    jobs:
      - test
      - build-wasm
      - build-jvm
      - build-android
      - build-ios
